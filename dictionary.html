<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictionary — Bulgarian → English</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="brand">Bulgarian → English trainer</div>
        <nav class="tabs">
            <button class="tab" onclick="location.href='index.html'">Welcome</button>
            <button class="tab" onclick="location.href='practice.html'">Practice</button>
            <button class="tab active">Dictionary</button>
        </nav>
    </header>

    <main class="container">
        <div class="card">
            <!-- Add new word section -->
            <div class="dictionary-controls controls">
                <input id="dict-add-bul" class="input" placeholder="Bulgarian word">
                <input id="dict-add-eng" class="input" placeholder="English translation">
                <button id="dict-add-btn" class="btn">Add to dictionary</button>
            </div>

            <!-- Search section -->
            <div class="controls" style="margin-top: 16px">
                <input id="filter" class="input" placeholder="Search words...">
            </div>

            <!-- Word list -->
            <div class="table-container">
                <table class="dictionary-table">
                    <thead>
                        <tr>
                            <th>Bulgarian</th>
                            <th>English</th>
                        </tr>
                    </thead>
                    <tbody id="dict-list"></tbody>
                </table>
            </div>
        </div>
    </main>

<script>
let words = []; // {bulgarian, english}

// Parse text content into words array
function parseText(text) {
    return text.split('\n')
        .map(line => line.trim())
        .filter(line => line && line.includes(' - '))
        .map(line => {
            const parts = line.split(' - ');
            return {
                bulgarian: parts[0].trim(),
                english: parts.slice(1).join(' - ').trim()
            };
        });
}

// Load data from data.html and localStorage
async function loadData() {
    try {
        const response = await fetch('data.html');
        if (!response.ok) throw new Error('Could not load data.html');
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const el = doc.getElementById('dictionary-data');
        if (!el) throw new Error('Dictionary data not found');
        
        words = parseText(el.textContent || el.innerText);
        
        // Load additional words from localStorage
        const storedWords = localStorage.getItem('bulgarian-words');
        if (storedWords) {
            const additionalWords = JSON.parse(storedWords);
            words = [...additionalWords, ...words]; // Add stored words first
        }
        
        renderDictionary();
    } catch (err) {
        console.error('Loading failed:', err);
        
        // Fallback: load only from localStorage
        const storedWords = localStorage.getItem('bulgarian-words');
        if (storedWords) {
            words = JSON.parse(storedWords);
            renderDictionary();
        } else {
            alert('Failed to load dictionary data. Please make sure data.html is available or add some words first.');
        }
    }
}

// Render the dictionary table
function renderDictionary(filterText = '') {
    const dictList = document.getElementById('dict-list');
    let displayWords = words;

    if (filterText) {
        const searchText = filterText.toLowerCase();
        displayWords = words.filter(word => 
            word.bulgarian.toLowerCase().includes(searchText) ||
            word.english.toLowerCase().includes(searchText)
        );
    }
    dictList.innerHTML = displayWords
        .map(word => `<tr><td>${word.bulgarian}</td><td>${word.english}</td></tr>`)
        .join('');
}

// Add a new word
async function addWord(bulgarian, english) {
    if (!bulgarian || !english) {
        alert('Please enter both Bulgarian and English words');
        return;
    }

    // Check for duplicates
    if (words.some(w => w.bulgarian.toLowerCase() === bulgarian.toLowerCase() && w.english.toLowerCase() === english.toLowerCase())) {
        alert('This word pair already exists in the dictionary');
        return;
    }

    // Add to beginning of array so it's visible immediately
    words.unshift({ bulgarian, english });
    renderDictionary();

    // Save to localStorage
    const storedWords = localStorage.getItem('bulgarian-words') || '[]';
    const additionalWords = JSON.parse(storedWords);
    additionalWords.unshift({ bulgarian, english });
    localStorage.setItem('bulgarian-words', JSON.stringify(additionalWords));

    // Prompt for PAT token
    const pat = prompt('Enter your GitHub PAT token to update data.html:');
    if (!pat) {
        alert('PAT token required to update data.html');
        return;
    }

    try {
        // Fetch current data.html from GitHub
        const url = 'https://api.github.com/repos/bratoforkata/bulgarian/contents/data.html';
        const headers = { Authorization: `token ${pat}` };
        const response = await fetch(url, { headers });
        if (!response.ok) throw new Error('Failed to fetch data.html from GitHub');

        const data = await response.json();
        const sha = data.sha;
        const content = atob(data.content); // Decode base64

        // Find and update the dictionary-data div content
        const divStartTag = '<div id="dictionary-data">';
        const divEndTag = '</div>';
        const start = content.indexOf(divStartTag);
        if (start === -1) throw new Error('Dictionary data div not found');

        const divStart = start + divStartTag.length;
        const end = content.indexOf(divEndTag, divStart);
        if (end === -1) throw new Error('End of dictionary data div not found');

        const existingContent = content.substring(divStart, end);
        const newLine = '\n' + bulgarian + ' - ' + english;
        const updatedContent = existingContent + newLine;
        const newFullContent = content.substring(0, divStart) + updatedContent + content.substring(end);

        // Encode back to base64
        const newEncoded = btoa(newFullContent);

        // Update the file on GitHub
        const updateResponse = await fetch(url, {
            method: 'PUT',
            headers: {
                Authorization: `token ${pat}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Add word: ${bulgarian} - ${english}`,
                content: newEncoded,
                sha: sha
            })
        });

        if (!updateResponse.ok) throw new Error('Failed to update data.html on GitHub');

        alert('Word added to data.html on GitHub successfully!');
    } catch (error) {
        alert('Error updating data.html: ' + error.message);
    }

    // Clear input fields
    document.getElementById('dict-add-bul').value = '';
    document.getElementById('dict-add-eng').value = '';
}

// Event Listeners
document.getElementById('filter').addEventListener('input', (e) => {
    renderDictionary(e.target.value.trim());
});

document.getElementById('dict-add-btn').addEventListener('click', async () => {
    const bulWord = document.getElementById('dict-add-bul').value.trim();
    const engWord = document.getElementById('dict-add-eng').value.trim();
    await addWord(bulWord, engWord);
});

// Initialize
loadData();
</script>
</body>
</html>
