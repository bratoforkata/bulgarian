<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictionary — Bulgarian → English</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="brand">Bulgarian → English trainer</div>
        <nav class="tabs">
            <button class="tab" onclick="location.href='index.html'">Welcome</button>
            <button class="tab" onclick="location.href='practice.html'">Practice</button>
            <button class="tab active">Dictionary</button>
        </nav>
    </header>

    <main class="container">
        <div class="card">
            <!-- Controls section - search and download on same line -->
            <div class="controls dictionary-controls">
                <input id="filter" class="input" placeholder="Search words...">
                <button id="download-btn" class="btn btn-secondary">Download Study File</button>
            </div>

            <!-- Word list -->
            <div class="table-container">
                <table class="dictionary-table">
                    <thead>
                        <tr>
                            <th>Bulgarian</th>
                            <th>English</th>
                        </tr>
                    </thead>
                    <tbody id="dict-list"></tbody>
                </table>
            </div>
        </div>
    </main>

<script>
let words = []; // {id, bulgarian, english, stats}

// Load data from data.json
async function loadData() {
    try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error('Could not load data.json');
        
        const data = await response.json();
        words = data.words || [];
        
        // Load additional words from localStorage (for backwards compatibility)
        const storedWords = localStorage.getItem('bulgarian-words');
        if (storedWords) {
            const additionalWords = JSON.parse(storedWords);
            
            // Convert old format to new format and add to words
            const newWords = additionalWords.map((word, index) => ({
                id: words.length + index + 1000, // Avoid ID conflicts
                bulgarian: word.bulgarian,
                english: word.english,
                stats: {
                    attempts: 0,
                    successes: 0,
                    lastShown: null,
                    successRate: 0
                }
            }));
            
            words = [...words, ...newWords];
            
            // Remove duplicates based on case-insensitive comparison
            const seen = new Set();
            words = words.filter(word => {
                const key = word.bulgarian.toLowerCase() + '|' + word.english.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }
        
        renderDictionary();
    } catch (err) {
        console.error('Loading failed:', err);
        
        // Fallback: load only from localStorage
        const storedWords = localStorage.getItem('bulgarian-words');
        if (storedWords) {
            words = JSON.parse(storedWords);
            renderDictionary();
        } else {
            alert('Failed to load dictionary data. Please make sure data.json is available or add some words first.');
        }
    }
}

// Render the dictionary table
function renderDictionary(filterText = '') {
    const dictList = document.getElementById('dict-list');
    let displayWords = words;

    if (filterText) {
        const searchText = filterText.toLowerCase();
        displayWords = words.filter(word => 
            word.bulgarian.toLowerCase().includes(searchText) ||
            word.english.toLowerCase().includes(searchText)
        );
    }
    
    dictList.innerHTML = displayWords
        .map(word => `
            <tr>
                <td>${word.bulgarian}</td>
                <td>${word.english}</td>
            </tr>
        `)
        .join('');
}

// Download study file
function downloadStudyFile() {
    if (words.length === 0) {
        alert('No words available to download');
        return;
    }

    // Create the content for the study file
    const content = words.map(word => `${word.bulgarian} - ${word.english}`).join('\n');

    // Create a blob with the content
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });

    // Create a download link
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'bulgarian-study-words.txt';

    // Trigger the download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Clean up the URL object
    URL.revokeObjectURL(link.href);
}

// Event Listeners
document.getElementById('filter').addEventListener('input', (e) => {
    renderDictionary(e.target.value.trim());
});

document.getElementById('download-btn').addEventListener('click', () => {
    downloadStudyFile();
});

// Initialize
loadData();
</script>
</body>
</html>
