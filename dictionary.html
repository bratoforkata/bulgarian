<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dictionary — Bulgarian → English</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="header">
        <div class="brand">Bulgarian → English trainer</div>
        <nav class="tabs">
            <button class="tab" onclick="location.href='index.html'">Welcome</button>
            <button class="tab" onclick="location.href='practice.html'">Practice</button>
            <button class="tab active">Dictionary</button>
        </nav>
    </header>

    <main class="container">
        <div class="card">
            <!-- Type selection buttons -->
            <div class="controls">
                <button id="words-btn" class="btn active">Words</button>
                <button id="sentences-btn" class="btn">Sentences</button>
            </div>

            <!-- Controls section - search and download on same line -->
            <div class="controls dictionary-controls">
                <input id="filter" class="input" placeholder="Search...">
                <button id="download-btn" class="btn btn-secondary">Download Study File</button>
            </div>

            <!-- Word list -->
            <div class="table-container">
                <table class="dictionary-table">
                    <thead>
                        <tr>
                            <th>Bulgarian</th>
                            <th>English</th>
                        </tr>
                    </thead>
                    <tbody id="dict-list"></tbody>
                </table>
            </div>
        </div>
    </main>

<script>
let words = []; // {id, bulgarian, english, stats}
let sentences = []; // {id, bulgarian, english}
let currentMode = 'words'; // 'words' or 'sentences'

// Load data from words.json and sentences.json
async function loadData() {
    try {
        // Load words
        const wordsResponse = await fetch('data/words.json');
        if (!wordsResponse.ok) throw new Error('Could not load words.json');
        const wordsData = await wordsResponse.json();
        words = wordsData.words || [];
        
        // Load additional words from localStorage (for backwards compatibility)
        const storedWords = localStorage.getItem('bulgarian-words');
        if (storedWords) {
            const additionalWords = JSON.parse(storedWords);
            
            // Convert old format to new format and add to words
            const newWords = additionalWords.map((word, index) => ({
                id: words.length + index + 1000, // Avoid ID conflicts
                bulgarian: word.bulgarian,
                english: word.english,
                stats: {
                    attempts: 0,
                    successes: 0,
                    lastShown: null,
                    successRate: 0
                }
            }));
            
            words = [...words, ...newWords];
            
            // Remove duplicates based on case-insensitive comparison
            const seen = new Set();
            words = words.filter(word => {
                const key = word.bulgarian.toLowerCase() + '|' + word.english.toLowerCase();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        // Load sentences from sentence-practise.json
        const sentencesResponse = await fetch('data/sentence-practise.json');
        if (!sentencesResponse.ok) throw new Error('Could not load sentence-practise.json');
        const practiceSentences = await sentencesResponse.json();
        
        // Convert practice sentence format to dictionary format
        sentences = practiceSentences.map(sentence => ({
            id: sentence.id,
            bulgarian: sentence.question_bg.replace('____', sentence.answer),
            english: sentence.translation_en
        }));
        
        renderDictionary();
    } catch (err) {
        console.error('Loading failed:', err);
        
        // Fallback: load only from localStorage for words
        const storedWords = localStorage.getItem('bulgarian-words');
        if (storedWords) {
            words = JSON.parse(storedWords);
            renderDictionary();
        } else {
            alert('Failed to load dictionary data. Please make sure words.json and sentence-practise.json are available.');
        }
    }
}

// Render the dictionary table
function renderDictionary(filterText = '') {
    const dictList = document.getElementById('dict-list');
    let displayItems = currentMode === 'words' ? words : sentences;

    if (filterText) {
        const searchText = filterText.toLowerCase();
        displayItems = displayItems.filter(item => 
            item.bulgarian.toLowerCase().includes(searchText) ||
            item.english.toLowerCase().includes(searchText)
        );
    }
    
    dictList.innerHTML = displayItems
        .map(item => `
            <tr>
                <td>${item.bulgarian}</td>
                <td>${item.english}</td>
            </tr>
        `)
        .join('');
}

// Download study file
function downloadStudyFile() {
    const items = currentMode === 'words' ? words : sentences;
    if (items.length === 0) {
        alert(`No ${currentMode} available to download`);
        return;
    }

    // Create the content for the study file
    const content = items.map(item => `${item.bulgarian} - ${item.english}`).join('\n');

    // Create a blob with the content
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });

    // Create a download link
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `bulgarian-study-${currentMode}.txt`;

    // Trigger the download
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Clean up the URL object
    URL.revokeObjectURL(link.href);
}

// Event Listeners
document.getElementById('filter').addEventListener('input', (e) => {
    renderDictionary(e.target.value.trim());
});

document.getElementById('download-btn').addEventListener('click', () => {
    downloadStudyFile();
});

document.getElementById('words-btn').addEventListener('click', () => {
    currentMode = 'words';
    document.getElementById('words-btn').classList.add('active');
    document.getElementById('sentences-btn').classList.remove('active');
    document.getElementById('filter').placeholder = 'Search words...';
    renderDictionary();
});

document.getElementById('sentences-btn').addEventListener('click', () => {
    currentMode = 'sentences';
    document.getElementById('sentences-btn').classList.add('active');
    document.getElementById('words-btn').classList.remove('active');
    document.getElementById('filter').placeholder = 'Search sentences...';
    renderDictionary();
});

// Initialize
loadData();
</script>
</body>
</html>
