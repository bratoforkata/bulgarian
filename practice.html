<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Practice — Bulgarian → English</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="brand">Bulgarian → English trainer</div>
    <nav class="tabs">
      <button class="tab" onclick="location.href='index.html'">Welcome</button>
      <button class="tab active">Practice</button>
      <button class="tab" onclick="location.href='dictionary.html'">Dictionary</button>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div class="practice-controls">
        <button id="language-toggle" class="btn btn-secondary">Mode: Bulgarian → English</button>
        <button id="reset-session" class="btn btn-ghost">Reset Session</button>
      </div>
      
      <div class="practice-layout">
        <div>
          <div class="word-big" id="word-english">—</div>
          <div class="small-muted" id="word-bulgarian">—</div>
        </div>
        <div class="practice-actions">
          <button id="start-practice" class="btn">Start Practice</button>
        </div>
      </div>
      <div class="practice-help small-muted">Click Start Practice to begin. Translations will appear after 5 seconds, then use Success/Fail/Skip buttons. Words advance automatically.</div>
      <div id="feedback-message" class="feedback-message"></div>
    </section>

    <section class="card accuracy-section">
      <div class="accuracy-layout">
        <div class="accuracy-meter">
          <div class="accuracy-display">Accuracy: 0%</div>
          <div class="stats-details"></div>
        </div>
        <div class="feedback-buttons">
          <button id="success-btn" class="btn success-btn" disabled>✓ Success</button>
          <button id="fail-btn" class="btn fail-btn" disabled>✗ Fail</button>
          <button id="skip-btn" class="btn btn-ghost" disabled>⏭ Skip</button>
        </div>
      </div>
    </section>

    <!-- Final Results Section -->
    <section class="card final-results" id="final-results" style="display: none;">
      <h2>Session Complete!</h2>
      <div class="results-summary">
        <div class="result-item">
          <span class="result-label">Total Words:</span>
          <span class="result-value" id="total-words">65</span>
        </div>
        <div class="result-item">
          <span class="result-label">Correct:</span>
          <span class="result-value" id="correct-count">0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Incorrect:</span>
          <span class="result-value" id="incorrect-count">0</span>
        </div>
        <div class="result-item">
          <span class="result-label">Skipped:</span>
          <span class="result-value" id="skipped-count">0</span>
        </div>
        <div class="result-item result-accuracy">
          <span class="result-label">Accuracy:</span>
          <span class="result-value" id="final-accuracy">0%</span>
        </div>
      </div>
      <div class="results-actions">
        <button id="start-new-session" class="btn">Start New Session</button>
        <button id="back-to-welcome" class="btn btn-secondary" onclick="location.href='index.html'">Back to Welcome</button>
      </div>
    </section>
  </main>

<script src="js/wordManager.js"></script>
<script src="js/uiManager.js"></script>
<script>
        // Initialize managers
        const wordManager = new WordManager();
        const uiManager = new UIManager();
        
        // Current word being tested
        let currentWord = null;
        let isWaitingForReveal = false;

        // Initialize the application
        async function initApp() {
            try {
                // Load words and initialize UI
                await wordManager.loadWords();
                uiManager.init();
                
                // Start a new session
                wordManager.startNewSession();
                
                // Setup event listeners
                setupEventListeners();
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('word-english').textContent = 'Error loading words';
                document.getElementById('word-bulgarian').textContent = 'Please check data.json';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Start practice button
            document.getElementById('start-practice').addEventListener('click', showNextWord);

            // Language toggle button
            document.getElementById('language-toggle').addEventListener('click', () => {
                if (isWaitingForReveal) return; // Prevent toggle during reveal animation
                uiManager.toggleLanguageMode();
            });

            // Reset session button
            document.getElementById('reset-session').addEventListener('click', resetSession);

            // Success button
            document.getElementById('success-btn').addEventListener('click', () => {
                handleWordResult(true);
            });

            // Fail button
            document.getElementById('fail-btn').addEventListener('click', () => {
                handleWordResult(false);
            });

            // Skip button
            document.getElementById('skip-btn').addEventListener('click', () => {
                handleWordSkip();
            });

            // Start new session button
            document.getElementById('start-new-session').addEventListener('click', startNewSession);
        }

        // Show next word with intelligent selection
        function showNextWord() {
            if (isWaitingForReveal) return;
            
            // Check if session is complete
            if (wordManager.isSessionComplete()) {
                showFinalResults();
                return;
            }
            
            currentWord = wordManager.getNextWord();
            if (!currentWord) {
                alert('No more words available! Start a new session.');
                return;
            }

            // Hide start button after first word
            const startBtn = document.getElementById('start-practice');
            if (startBtn && startBtn.style.display !== 'none') {
                startBtn.style.display = 'none';
            }

            isWaitingForReveal = true;
            setLanguageToggleEnabled(false); // Disable language toggle during animation
            
            // Start word reveal process
            uiManager.startWordReveal(currentWord, () => {
                isWaitingForReveal = false;
                setLanguageToggleEnabled(true); // Re-enable language toggle
            });

            // Update stats display
            updateStatsDisplay();
        }

        // Handle word result (success/fail)
        function handleWordResult(success) {
            if (!currentWord) return;
            
            // If clicked early (before reveal), stop the timer and reveal the word
            if (isWaitingForReveal) {
                uiManager.stopProgressAnimation();
                uiManager.displayWord(currentWord, true); // Reveal the translation
                isWaitingForReveal = false;
                setLanguageToggleEnabled(true); // Re-enable language toggle
            }

            // Record the attempt
            wordManager.recordWordAttempt(currentWord.id, success);

            // Show feedback
            if (success) {
                uiManager.showSuccessFeedback();
            } else {
                uiManager.showFailureFeedback();
            }

            // Update displays
            updateStatsDisplay();

            // Auto-advance to next word
            uiManager.autoAdvanceAfterAction(() => {
                showNextWord();
            });
        }

        // Handle word skip
        function handleWordSkip() {
            if (!currentWord) return;

            // Stop any ongoing animation if we're skipping
            if (isWaitingForReveal) {
                uiManager.stopProgressAnimation();
                isWaitingForReveal = false;
                setLanguageToggleEnabled(true); // Re-enable language toggle
            }

            // Record the skip
            wordManager.skipWord(currentWord.id);

            // Show feedback
            uiManager.showSkipFeedback();

            // Update stats display
            updateStatsDisplay();

            // Auto-advance to next word
            uiManager.autoAdvanceAfterAction(() => {
                showNextWord();
            });
        }

        // Update statistics display
        function updateStatsDisplay() {
            const stats = wordManager.getSessionStats();
            uiManager.updateStatsDisplay(stats);
        }

        // Control language toggle button state
        function setLanguageToggleEnabled(enabled) {
            const toggleBtn = document.getElementById('language-toggle');
            if (toggleBtn) {
                toggleBtn.disabled = !enabled;
                toggleBtn.style.opacity = enabled ? '1' : '0.6';
            }
        }

        // Reset session statistics
        function resetSession() {
            if (confirm('Reset current session? This will start a new session with 65 random words.')) {
                startNewSession();
            }
        }

        // Show final results
        function showFinalResults() {
            const results = wordManager.getFinalResults();
            if (!results) return;

            // Hide practice sections
            document.querySelector('.practice-layout').style.display = 'none';
            document.querySelector('.accuracy-section').style.display = 'none';

            // Show final results
            const finalResultsSection = document.getElementById('final-results');
            finalResultsSection.style.display = 'block';

            // Update results display
            document.getElementById('total-words').textContent = results.totalWords;
            document.getElementById('correct-count').textContent = results.correct;
            document.getElementById('incorrect-count').textContent = results.incorrect;
            document.getElementById('skipped-count').textContent = results.skipped;
            document.getElementById('final-accuracy').textContent = results.accuracy + '%';

            // Stop any ongoing animations
            uiManager.stopProgressAnimation();
            isWaitingForReveal = false;
            setLanguageToggleEnabled(false);
        }

        // Start a new session
        function startNewSession() {
            try {
                // Start new session
                wordManager.startNewSession();

                // Hide final results, show practice sections
                document.getElementById('final-results').style.display = 'none';
                document.querySelector('.practice-layout').style.display = 'block';
                document.querySelector('.accuracy-section').style.display = 'block';

                // Reset UI
                document.getElementById('word-english').textContent = '—';
                document.getElementById('word-bulgarian').textContent = '—';
                currentWord = null;
                isWaitingForReveal = false;

                // Show start button
                const startBtn = document.getElementById('start-practice');
                if (startBtn) {
                    startBtn.style.display = 'inline-block';
                }

                // Reset stats display
                updateStatsDisplay();

                // Re-enable language toggle
                setLanguageToggleEnabled(true);

                // Disable action buttons
                uiManager.setActionButtonsEnabled(false);
                document.getElementById('skip-btn').disabled = true;

            } catch (error) {
                alert('Error starting new session: ' + error.message);
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
