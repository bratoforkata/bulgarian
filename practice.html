<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Practice — Bulgarian → English</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <header class="header">
    <div class="brand">Bulgarian → English trainer</div>
    <nav class="tabs">
      <button class="tab" onclick="location.href='index.html'">Welcome</button>
      <button class="tab active">Practice</button>
      <button class="tab" onclick="location.href='dictionary.html'">Dictionary</button>
    </nav>
  </header>

  <main class="container">
    <section class="card">
      <div class="practice-controls">
        <button id="language-toggle" class="btn btn-secondary">Mode: Bulgarian → English</button>
        <button id="reset-session" class="btn btn-ghost">Reset Session</button>
      </div>
      
      <div class="practice-layout">
        <div>
          <div class="word-big" id="word-english">—</div>
          <div class="small-muted" id="word-bulgarian">—</div>
        </div>
        <div class="practice-actions">
          <button id="start-practice" class="btn">Start Practice</button>
        </div>
      </div>
      <div class="practice-help small-muted">Click Start Practice to begin. Translations will appear after 5 seconds, then use Success/Fail/Skip buttons. Words advance automatically.</div>
      <div id="feedback-message" class="feedback-message"></div>
    </section>

    <section class="card accuracy-section">
      <div class="accuracy-layout">
        <div class="accuracy-meter">
          <div class="accuracy-display">Accuracy: 0%</div>
          <div class="stats-details"></div>
        </div>
        <div class="feedback-buttons">
          <button id="success-btn" class="btn success-btn" disabled>✓ Success</button>
          <button id="fail-btn" class="btn fail-btn" disabled>✗ Fail</button>
          <button id="skip-btn" class="btn btn-ghost" disabled>⏭ Skip</button>
        </div>
      </div>
      <div class="failed-words-section">
        <h3>Words to Review</h3>
        <textarea id="failed-words-list" readonly placeholder="Words that you failed will appear here..."></textarea>
        <button id="copy-failed-btn" class="btn btn-secondary">Copy Words to Review</button>
      </div>
    </section>
  </main>

<script src="js/wordManager.js"></script>
<script src="js/uiManager.js"></script>
<script>
        // Initialize managers
        const wordManager = new WordManager();
        const uiManager = new UIManager();
        
        // Current word being tested
        let currentWord = null;
        let isWaitingForReveal = false;

        // Initialize the application
        async function initApp() {
            try {
                // Load words and initialize UI
                await wordManager.loadWords();
                uiManager.init();
                
                // Setup event listeners
                setupEventListeners();
                
                console.log('App initialized successfully');
            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('word-english').textContent = 'Error loading words';
                document.getElementById('word-bulgarian').textContent = 'Please check data.json';
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Start practice button
            document.getElementById('start-practice').addEventListener('click', showNextWord);

            // Language toggle button
            document.getElementById('language-toggle').addEventListener('click', () => {
                if (isWaitingForReveal) return; // Prevent toggle during reveal animation
                uiManager.toggleLanguageMode();
            });

            // Reset session button
            document.getElementById('reset-session').addEventListener('click', resetSession);

            // Success button
            document.getElementById('success-btn').addEventListener('click', () => {
                handleWordResult(true);
            });

            // Fail button
            document.getElementById('fail-btn').addEventListener('click', () => {
                handleWordResult(false);
            });

            // Skip button
            document.getElementById('skip-btn').addEventListener('click', () => {
                handleWordSkip();
            });

            // Copy failed words button
            document.getElementById('copy-failed-btn').addEventListener('click', copyFailedWords);
        }

        // Show next word with intelligent selection
        function showNextWord() {
            if (isWaitingForReveal) return;
            
            currentWord = wordManager.getNextWord();
            if (!currentWord) {
                alert('No more words available!');
                return;
            }

            // Hide start button after first word
            const startBtn = document.getElementById('start-practice');
            if (startBtn && startBtn.style.display !== 'none') {
                startBtn.style.display = 'none';
                // Clear failed words list when starting new session
                uiManager.clearFailedWordsList();
            }

            isWaitingForReveal = true;
            setLanguageToggleEnabled(false); // Disable language toggle during animation
            
            // Start word reveal process
            uiManager.startWordReveal(currentWord, () => {
                isWaitingForReveal = false;
                setLanguageToggleEnabled(true); // Re-enable language toggle
            });

            // Update stats display
            updateStatsDisplay();
        }

        // Handle word result (success/fail)
        function handleWordResult(success) {
            if (!currentWord || isWaitingForReveal) return;

            // Record the attempt
            wordManager.recordWordAttempt(currentWord.id, success);

            // Show feedback
            if (success) {
                uiManager.showSuccessFeedback();
            } else {
                uiManager.showFailureFeedback();
            }

            // Update displays
            updateStatsDisplay();
            updateFailedWordsList();

            // Auto-advance to next word
            uiManager.autoAdvanceAfterAction(() => {
                showNextWord();
            });
        }

        // Handle word skip
        function handleWordSkip() {
            if (!currentWord) return;

            // Stop any ongoing animation if we're skipping
            if (isWaitingForReveal) {
                uiManager.stopProgressAnimation();
                isWaitingForReveal = false;
                setLanguageToggleEnabled(true); // Re-enable language toggle
            }

            // Record the skip
            wordManager.skipWord(currentWord.id);

            // Show feedback
            uiManager.showSkipFeedback();

            // Update stats display
            updateStatsDisplay();

            // Auto-advance to next word
            uiManager.autoAdvanceAfterAction(() => {
                showNextWord();
            });
        }

        // Update statistics display
        function updateStatsDisplay() {
            const stats = wordManager.getSessionStats();
            uiManager.updateStatsDisplay(stats);
        }

        // Update failed words list
        function updateFailedWordsList() {
            const failedWords = wordManager.getFailedWordsInSession();
            uiManager.updateFailedWordsList(failedWords);
        }

        // Control language toggle button state
        function setLanguageToggleEnabled(enabled) {
            const toggleBtn = document.getElementById('language-toggle');
            if (toggleBtn) {
                toggleBtn.disabled = !enabled;
                toggleBtn.style.opacity = enabled ? '1' : '0.6';
            }
        }

        // Reset session statistics
        function resetSession() {
            if (confirm('Reset session statistics? This will not affect your long-term word progress.')) {
                wordManager.resetSessionStats();
                updateStatsDisplay();
                uiManager.stopProgressAnimation();
                
                // Reset display
                document.getElementById('word-english').textContent = '—';
                document.getElementById('word-bulgarian').textContent = '—';
                currentWord = null;
                isWaitingForReveal = false;
                
                // Disable all action buttons
                uiManager.setActionButtonsEnabled(false);
                document.getElementById('skip-btn').disabled = true; // Explicitly disable skip until practice starts
                
                // Re-enable language toggle
                setLanguageToggleEnabled(true);
                
                // Show start button again
                const startBtn = document.getElementById('start-practice');
                if (startBtn) {
                    startBtn.style.display = 'inline-block';
                }
                
                // Clear failed words list
                uiManager.clearFailedWordsList();
            }
        }

        // Copy failed words to clipboard
        function copyFailedWords() {
            const textarea = document.getElementById('failed-words-list');
            if (textarea.value) {
                textarea.select();
                document.execCommand('copy');
                alert('Words to review copied to clipboard!');
            } else {
                alert('No words to copy yet. Practice some words first!');
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
